<!DOCTYPE html>
<html>
<head>
    <title>Penguin Escape: Mobile Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { text-align: center; background: #001b3a; color: white; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; touch-action: none; }
        canvas { background: #003366; border-bottom: 3px solid #fff; display: block; margin: 0 auto; width: 100vw; height: 50vh; object-fit: contain; }
        
        /* Stats Bar */
        .ui-bar { background: #001b3a; padding: 10px; font-size: 18px; font-weight: bold; }
        #streak-info { color: #f1c40f; font-size: 14px; margin-top: 5px; height: 18px; }

        /* QUIZ OVERLAY */
        #quiz-overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: white; color: black; padding: 20px; border-radius: 20px; width: 85%; max-width: 350px; border: 5px solid #3498db; z-index: 1000; }
        .quiz-btn { padding: 12px; margin: 5px 0; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 8px; width: 100%; font-size: 16px; font-weight: bold; }

        /* VIRTUAL CONTROLS */
        .controller { position: absolute; bottom: 20px; left: 0; right: 0; height: 150px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; pointer-events: none; }
        .d-pad, .fire-zone { pointer-events: auto; }
        
        .arrow-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 3px solid white; border-radius: 15px; margin: 5px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        
        /* BIG RED DOT */
        .red-dot { width: 100px; height: 100px; background: #e74c3c; border: 5px solid #c0392b; border-radius: 50%; box-shadow: 0 5px #962d22, 0 10px 20px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 20px; }
        .red-dot:active { transform: translateY(4px); box-shadow: 0 2px #962d22; }
    </style>
</head>
<body>

    <div class="ui-bar">
        ‚ù§Ô∏è <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span> | ‚≠ê <span id="score">0</span>/10
        <div id="streak-info">Streak: 0</div>
    </div>
    
    <canvas id="gameCanvas" width="800" height="400"></canvas>

    <div class="controller">
        <div class="d-pad">
            <div class="arrow-btn" id="btnUp">üîº</div>
            <div class="arrow-btn" id="btnDown">üîΩ</div>
        </div>
        <div class="fire-zone">
            <div class="red-dot" id="btnFire">FIRE</div>
        </div>
    </div>

    <div id="quiz-overlay">
        <h2 style="color:#e74c3c; margin-top:0;">GRAMMAR STOP!</h2>
        <p id="question" style="font-weight:bold;"></p>
        <div id="options"></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let score = 0, lives = 3, streak = 0, gameActive = true, isVictory = false, frameCount = 0;
let penguin = { x: 80, y: 180 }, iceCubes = [], bears = [], keys = {};
let powerUpTimer = 0;
const POWER_UP_DURATION = 600;

const questions = [
    { q: "I wanted to go swimming, ___ it was too cold.", a: ["but", "because", "unless"], correct: "but" },
    { q: "You won't catch the bus ___ you run faster.", a: ["since", "unless", "so"], correct: "unless" },
    { q: "___ it was raining, we played football.", a: ["Although", "Because", "So"], correct: "Although" },
    { q: "He studied hard, ___ he passed the exam.", a: ["but", "so", "unless"], correct: "so" },
    { q: "I'll call you ___ I arrive at the station.", a: ["although", "when", "but"], correct: "when" },
    { q: "We stayed home ___ the weather was terrible.", a: ["because", "but", "unless"], correct: "because" },
    { q: "You can eat cake ___ you finish your dinner.", a: ["however", "provided that", "but"], correct: "provided that" },
    { q: "The tea was hot, ___ I drank it slowly.", a: ["so", "although", "unless"], correct: "so" },
    { q: "___ he is rich, he lives in a small house.", a: ["Because", "Even though", "So"], correct: "Even though" },
    { q: "I'll help you ___ you help me first.", a: ["if", "but", "although"], correct: "if" }
];

// INPUT HANDLING
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => { if(e.code === 'Space') fire(); keys[e.code] = false; });

function bindTouch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
}
bindTouch('btnUp', 'ArrowUp');
bindTouch('btnDown', 'ArrowDown');
document.getElementById('btnFire').addEventListener('touchstart', (e) => { e.preventDefault(); fire(); });

function fire() {
    if(gameActive && !isVictory) {
        let size = (powerUpTimer > 0) ? 120 : 30;
        iceCubes.push({ x: penguin.x + 50, y: penguin.y + 20, size: size });
    }
}

function triggerQuiz() {
    gameActive = false;
    document.getElementById('quiz-overlay').style.display = 'block';
    let q = questions[score % questions.length];
    document.getElementById('question').innerText = q.q;
    let optDiv = document.getElementById('options');
    optDiv.innerHTML = '';
    
    q.a.forEach(opt => {
        let btn = document.createElement('button');
        btn.className = 'quiz-btn';
        btn.innerText = opt;
        btn.onclick = () => {
            if(opt === q.correct) {
                score++; streak++;
                if(streak >= 3) { powerUpTimer = POWER_UP_DURATION; streak = 0; }
            } else {
                lives--; streak = 0; powerUpTimer = 0;
            }
            document.getElementById('score').innerText = score;
            document.getElementById('hearts').innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
            document.getElementById('quiz-overlay').style.display = 'none';
            if(lives <= 0) { alert("Game Over!"); location.reload(); }
            else if(score >= 10) { isVictory = true; gameActive = false; }
            else { gameActive = true; }
        };
        optDiv.appendChild(btn);
    });
}

function draw() {
    ctx.clearRect(0, 0, 800, 400);

    if(gameActive && !isVictory) {
        frameCount++;
        if(powerUpTimer > 0) {
            powerUpTimer--;
            document.getElementById('streak-info').innerText = "‚ö° MEGA ICE: " + Math.ceil(powerUpTimer/60) + "s ‚ö°";
        } else {
            document.getElementById('streak-info').innerText = "Streak: " + streak;
        }

        if(keys['ArrowUp'] && penguin.y > 0) penguin.y -= 5;
        if(keys['ArrowDown'] && penguin.y < 350) penguin.y += 5;
        if(frameCount % 150 === 0) {
            let sy = Math.random() * 300 + 50;
            bears.push({ x: 850, y: sy, baseLineY: sy, offset: Math.random() * 100, hp: 2 });
        }

        iceCubes.forEach((c, i) => { c.x += 10; if(c.x > 800) iceCubes.splice(i, 1); });

        bears.forEach((b, i) => {
            let speed = (powerUpTimer > 0) ? 0.5 : 1.0;
            b.x -= speed;
            b.y = (powerUpTimer > 0) ? b.baseLineY + Math.sin((frameCount + b.offset) * 0.05) * 60 : b.baseLineY;

            if(b.x < 0) { 
                bears.splice(i,1); lives--; streak = 0; powerUpTimer = 0;
                document.getElementById('hearts').innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
                if(lives <= 0) { alert("Game Over!"); location.reload(); }
            }
            iceCubes.forEach((c, ci) => {
                let hit = (powerUpTimer > 0) ? 80 : 50;
                if(Math.abs(c.x-b.x) < hit && Math.abs(c.y-b.y) < hit) {
                    bears.splice(i,1); iceCubes.splice(ci,1); triggerQuiz();
                }
            });
        });
    }

    // DRAW CHARACTERS
    ctx.font = "50px serif";
    let jump = isVictory ? Math.sin(Date.now() * 0.005) * 50 : 0;
    ctx.fillText(isVictory ? "ü•≥" : "üêß", penguin.x, penguin.y + jump + 40);
    if(!isVictory) { ctx.font = "30px serif"; ctx.fillText("üò®", penguin.x + 10, penguin.y + jump - 10); }
    iceCubes.forEach(c => { ctx.font = c.size + "px serif"; ctx.fillText("‚ùÑÔ∏è", c.x, c.y); });
    bears.forEach(b => { ctx.font = "60px serif"; ctx.fillText("üêª‚Äç‚ùÑÔ∏è", b.x, b.y + 50); });

    if(isVictory) {
        ctx.fillStyle = "#f1c40f"; ctx.font = "bold 60px sans-serif";
        ctx.textAlign = "center"; ctx.fillText("VICTORY!", 400, 200);
    }
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
